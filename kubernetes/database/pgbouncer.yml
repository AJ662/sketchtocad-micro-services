# PgBouncer Connection Pooler for all PostgreSQL databases
# This reduces connection overhead and prevents connection exhaustion
# Using Bitnami PgBouncer image with environment variable configuration

---
# PgBouncer for Saga Database (Workflow Orchestrator)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer-saga
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgbouncer-saga
  template:
    metadata:
      labels:
        app: pgbouncer-saga
    spec:
      containers:
      - name: pgbouncer
        image: bitnami/pgbouncer:latest
        ports:
        - containerPort: 6432
        env:
        - name: POSTGRESQL_HOST
          value: "postgres-saga"
        - name: POSTGRESQL_PORT
          value: "5432"
        - name: POSTGRESQL_DATABASE
          value: "sagadb"
        - name: POSTGRESQL_USERNAME
          value: "postgres"
        - name: POSTGRESQL_PASSWORD
          value: "password"
        - name: PGBOUNCER_PORT
          value: "6432"
        - name: PGBOUNCER_POOL_MODE
          value: "transaction"
        - name: PGBOUNCER_MAX_CLIENT_CONN
          value: "1000"
        - name: PGBOUNCER_DEFAULT_POOL_SIZE
          value: "20"
        - name: PGBOUNCER_MIN_POOL_SIZE
          value: "5"
        - name: PGBOUNCER_RESERVE_POOL_SIZE
          value: "5"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer-saga
  namespace: default
spec:
  ports:
  - port: 6432
    targetPort: 6432
  selector:
    app: pgbouncer-saga

---
# PgBouncer for Image Processing Database
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer-image-processing
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgbouncer-image-processing
  template:
    metadata:
      labels:
        app: pgbouncer-image-processing
    spec:
      containers:
      - name: pgbouncer
        image: bitnami/pgbouncer:latest
        ports:
        - containerPort: 6432
        env:
        - name: POSTGRESQL_HOST
          value: "postgres-image-processing"
        - name: POSTGRESQL_PORT
          value: "5432"
        - name: POSTGRESQL_DATABASE
          value: "imageprocessingdb"
        - name: POSTGRESQL_USERNAME
          value: "postgres"
        - name: POSTGRESQL_PASSWORD
          value: "password"
        - name: PGBOUNCER_PORT
          value: "6432"
        - name: PGBOUNCER_POOL_MODE
          value: "transaction"
        - name: PGBOUNCER_MAX_CLIENT_CONN
          value: "1000"
        - name: PGBOUNCER_DEFAULT_POOL_SIZE
          value: "20"
        - name: PGBOUNCER_MIN_POOL_SIZE
          value: "5"
        - name: PGBOUNCER_RESERVE_POOL_SIZE
          value: "5"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer-image-processing
  namespace: default
spec:
  ports:
  - port: 6432
    targetPort: 6432
  selector:
    app: pgbouncer-image-processing

---
# PgBouncer for Clustering Database
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer-clustering
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgbouncer-clustering
  template:
    metadata:
      labels:
        app: pgbouncer-clustering
    spec:
      containers:
      - name: pgbouncer
        image: bitnami/pgbouncer:latest
        ports:
        - containerPort: 6432
        env:
        - name: POSTGRESQL_HOST
          value: "postgres-clustering"
        - name: POSTGRESQL_PORT
          value: "5432"
        - name: POSTGRESQL_DATABASE
          value: "clusteringdb"
        - name: POSTGRESQL_USERNAME
          value: "postgres"
        - name: POSTGRESQL_PASSWORD
          value: "password"
        - name: PGBOUNCER_PORT
          value: "6432"
        - name: PGBOUNCER_POOL_MODE
          value: "transaction"
        - name: PGBOUNCER_MAX_CLIENT_CONN
          value: "1000"
        - name: PGBOUNCER_DEFAULT_POOL_SIZE
          value: "20"
        - name: PGBOUNCER_MIN_POOL_SIZE
          value: "5"
        - name: PGBOUNCER_RESERVE_POOL_SIZE
          value: "5"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer-clustering
  namespace: default
spec:
  ports:
  - port: 6432
    targetPort: 6432
  selector:
    app: pgbouncer-clustering

---
# PgBouncer for DXF Export Database
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer-dxf-export
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgbouncer-dxf-export
  template:
    metadata:
      labels:
        app: pgbouncer-dxf-export
    spec:
      containers:
      - name: pgbouncer
        image: bitnami/pgbouncer:latest
        ports:
        - containerPort: 6432
        env:
        - name: POSTGRESQL_HOST
          value: "postgres-dxf-export"
        - name: POSTGRESQL_PORT
          value: "5432"
        - name: POSTGRESQL_DATABASE
          value: "dxfexportdb"
        - name: POSTGRESQL_USERNAME
          value: "postgres"
        - name: POSTGRESQL_PASSWORD
          value: "password"
        - name: PGBOUNCER_PORT
          value: "6432"
        - name: PGBOUNCER_POOL_MODE
          value: "transaction"
        - name: PGBOUNCER_MAX_CLIENT_CONN
          value: "1000"
        - name: PGBOUNCER_DEFAULT_POOL_SIZE
          value: "20"
        - name: PGBOUNCER_MIN_POOL_SIZE
          value: "5"
        - name: PGBOUNCER_RESERVE_POOL_SIZE
          value: "5"
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
---
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer-dxf-export
  namespace: default
spec:
  ports:
  - port: 6432
    targetPort: 6432
  selector:
    app: pgbouncer-dxf-export
