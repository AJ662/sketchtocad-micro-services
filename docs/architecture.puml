@startuml SketchToCad
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(user, "Garden Designer", "Analyzes garden sketches and exports to CAD")

System_Boundary(sketchToCad, "SketchToCad System") {
    Container(frontend, "Frontend", "Next.js, React", "Web UI for sketch upload and results")
    Container(apiGateway, "API Gateway", "Node.js, Express", "Routes requests, handles CORS and rate limiting")

    Container(workflowOrchestrator, "Workflow Orchestrator", "Python, FastAPI", "Coordinates the processing pipeline")
    ContainerDb(workflowDb, "Workflow Orchestrator DB", "PostgreSQL 16", "Standalone DB. Stores workflow runs, job state, idempotency keys")

    Container(imageProcessing, "Image Processing", "Python, FastAPI, OpenCV", "Detects plant bed borders")
    ContainerDb(imageDb, "Image Processing Cluster", "Citus (PostgreSQL 16)", "Sharded DB (Coordinator + Worker). Stores session metadata, distributed by ID.")

    Container(clustering, "Clustering", "Python, FastAPI, scikit-learn", "Groups plant beds by color")
    ContainerDb(clusterDb, "Clustering Cluster", "Citus (PostgreSQL 16)", "Sharded DB (Coordinator + Worker). Stores clustering results.")

    Container(dxfExport, "DXF Export", "Python, FastAPI, ezdxf", "Exports to CAD format")
    ContainerDb(dxfDb, "DXF Export Cluster", "Citus (PostgreSQL 16)", "Sharded DB (Coordinator + Worker). Stores export jobs.")
}

Rel(user, frontend, "Uses")
Rel(frontend, apiGateway, "Makes API calls", "HTTPS/JSON")
Rel(apiGateway, workflowOrchestrator, "Routes to", "HTTP/REST")

Rel(workflowOrchestrator, imageProcessing, "Step 1: Process image", "HTTP/REST")
Rel(workflowOrchestrator, clustering, "Step 2: Cluster beds", "HTTP/REST")
Rel(workflowOrchestrator, dxfExport, "Step 3: Export DXF", "HTTP/REST")

Rel(workflowOrchestrator, workflowDb, "Reads/Writes", "SQL")
Rel(imageProcessing, imageDb, "Reads/Writes (via Coordinator)", "SQL")
Rel(clustering, clusterDb, "Reads/Writes (via Coordinator)", "SQL")
Rel(dxfExport, dxfDb, "Reads/Writes (via Coordinator)", "SQL")

@enduml
