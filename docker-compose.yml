include:
  - docker-compose.infra.yml
  - docker-compose.observability.yml

services:
  # NEW: Workflow Orchestrator
  workflow-orchestrator:
    build: ./SketchToCad-workflow-orchestrator
    container_name: workflow-orchestrator
    ports:
      - "8004:8004"
    env_file:
      - ./sketchtocad-workflow-orchestrator/.env
    depends_on:
      image-processing:
        condition: service_healthy
      clustering:
        condition: service_healthy
      dxf-export:
        condition: service_healthy
      jaeger:
        condition: service_started
      prometheus:
        condition: service_started
    networks:
      - sketchtocad
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8004/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  orchestrator-worker:
    build: ./sketchtocad-workflow-orchestrator
    container_name: orchestrator-worker
    command: python -m app.workers.orchestrator_consumer
    env_file:
      - ./sketchtocad-workflow-orchestrator/.env
    environment:
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - LOG_LEVEL=INFO
      - SERVICE_NAME=orchestrator-worker
    depends_on:
      kafka:
        condition: service_healthy
      postgres-saga:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - sketchtocad
    restart: unless-stopped

  image-processing:
    build: ./SketchToCad-image-processing
    container_name: image-processing-service
    ports:
      - "8001:8001"
    env_file:
      - ./SketchToCad-image-processing/.env
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      jaeger:
        condition: service_started
      prometheus:
        condition: service_started
    networks:
      - sketchtocad
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    command: sh -c "sleep 10 && uvicorn app.main:app --host 0.0.0.0 --port 8001"

  image-processing-worker:
    build: ./SketchToCad-image-processing
    container_name: image-processing-worker
    command: python -m app.workers.event_consumer
    env_file:
      - ./SketchToCad-image-processing/.env
    environment:
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - LOG_LEVEL=INFO
      - SERVICE_NAME=image-processing-worker
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - sketchtocad
    restart: unless-stopped

  image-processing-sync-worker:
    build: ./SketchToCad-image-processing
    container_name: image-processing-sync-worker
    command: python -m app.workers.sync_consumer
    env_file:
      - ./SketchToCad-image-processing/.env
    environment:
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - LOG_LEVEL=INFO
      - SERVICE_NAME=image-processing-sync-worker
    depends_on:
      kafka:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - sketchtocad
    restart: unless-stopped

  clustering:
    build: ./SketchToCad-clustering
    container_name: clustering-service
    ports:
      - "8002:8002"
    env_file:
      - ./SketchToCad-clustering/.env
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres-clustering:5432/clusteringdb
    depends_on:
      postgres-clustering:
        condition: service_healthy
      jaeger:
        condition: service_started
      prometheus:
        condition: service_started
    networks:
      - sketchtocad
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  clustering-worker:
    build: ./SketchToCad-clustering
    container_name: clustering-worker
    command: python -m app.workers.event_consumer
    env_file:
      - ./SketchToCad-clustering/.env
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres-clustering:5432/clusteringdb
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - LOG_LEVEL=INFO
      - SERVICE_NAME=clustering-worker
    depends_on:
      kafka:
        condition: service_healthy
      postgres-clustering:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - sketchtocad
    restart: unless-stopped

  clustering-sync-worker:
    build: ./SketchToCad-clustering
    container_name: clustering-sync-worker
    command: python -m app.workers.sync_consumer
    env_file:
      - ./SketchToCad-clustering/.env
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres-clustering:5432/clusteringdb
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - LOG_LEVEL=INFO
      - SERVICE_NAME=clustering-sync-worker
    depends_on:
      kafka:
        condition: service_healthy
      postgres-clustering:
        condition: service_healthy
    networks:
      - sketchtocad
    restart: unless-stopped

  dxf-export:
    build: ./SketchToCad-image-to-cad
    container_name: dxf-export-service
    ports:
      - "8003:8003"
    env_file:
      - ./SketchToCad-image-to-cad/.env
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres-dxf-export:5432/dxfexportdb
    depends_on:
      postgres-dxf-export:
        condition: service_healthy
      jaeger:
        condition: service_started
      prometheus:
        condition: service_started
    networks:
      - sketchtocad
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8003/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  dxf-export-worker:
    build: ./SketchToCad-image-to-cad
    container_name: dxf-export-worker
    command: python -m app.workers.event_consumer
    env_file:
      - ./SketchToCad-image-to-cad/.env
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres-dxf-export:5432/dxfexportdb
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - LOG_LEVEL=INFO
      - SERVICE_NAME=dxf-export-worker
    depends_on:
      kafka:
        condition: service_healthy
      postgres-dxf-export:
        condition: service_healthy
      jaeger:
        condition: service_started
    networks:
      - sketchtocad
    restart: unless-stopped

  dxf-export-sync-worker:
    build: ./SketchToCad-image-to-cad
    container_name: dxf-export-sync-worker
    command: python -m app.workers.sync_consumer
    env_file:
      - ./SketchToCad-image-to-cad/.env
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres-dxf-export:5432/dxfexportdb
      - JAEGER_AGENT_HOST=jaeger
      - JAEGER_AGENT_PORT=6831
      - LOG_LEVEL=INFO
      - SERVICE_NAME=dxf-export-sync-worker
    depends_on:
      kafka:
        condition: service_healthy
      postgres-dxf-export:
        condition: service_healthy
    networks:
      - sketchtocad
    restart: unless-stopped

  api-gateway:
    build: ./SketchToCad-api-gateway
    container_name: api-gateway
    ports:
      - "8000:8000"
    env_file:
      - ./SketchToCad-api-gateway/.env
    depends_on:
      workflow-orchestrator:
        # CHANGED: Now depends on orchestrator instead of individual services
        condition: service_healthy
    networks:
      - sketchtocad
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  frontend:
    build:
      context: ./SketchToCad-Frontend
      dockerfile: Dockerfile
    container_name: sketchtocad-frontend
    ports:
      - "3000:3000"
    env_file:
      - ./SketchToCad-Frontend/.env
    depends_on:
      workflow-orchestrator:
        # CHANGED: Now depends on orchestrator
        condition: service_healthy
    networks:
      - sketchtocad
    restart: unless-stopped

networks:
  sketchtocad:
    driver: bridge
    name: sketchtocad-network
